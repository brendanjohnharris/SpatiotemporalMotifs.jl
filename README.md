# SpatiotemporalMotifs.jl

<!-- [![Stable](https://img.shields.io/badge/docs-stable-blue.svg)](https://brendanjohnharris.github.io/SpatiotemporalMotifs.jl/stable/)
[![Dev](https://img.shields.io/badge/docs-dev-blue.svg)](https://brendanjohnharris.github.io/SpatiotemporalMotifs.jl/dev/) -->
<!-- [![Build Status](https://github.com/brendanjohnharris/SpatiotemporalMotifs.jl/actions/workflows/CI.yml/badge.svg?branch=main)](https://github.com/brendanjohnharris/SpatiotemporalMotifs.jl/actions/workflows/CI.yml?query=branch%3Amain)
[![Coverage](https://codecov.io/gh/brendanjohnharris/SpatiotemporalMotifs.jl/branch/main/graph/badge.svg)](https://codecov.io/gh/brendanjohnharris/SpatiotemporalMotifs.jl) -->

## Guide

This project contains code for reproducing the analyses and figures in the paper "........................".
Since many analyses are computationally intensive, we recommend either:

1. Running the code on a high-performance computing cluster, which will require adapting the scripts to use the cluster manager of your local supercomputer. This option is described in [Section 1](#1.-performing-calculations) below.
2. Downloading the precomputed results from .....................................

If the results are downloaded from Figshare, skip directly to [Section 2](#2.-plotting-results). Please note that while plotting the downloaded results will not require a high-performance computing cluster, it will still require a computer with a modest amount of RAM (>16 GB) and some analyses will still take upwards of 30 minutes to complete.

### 0. Setup

Installation should be straightforward:
```julia
run(`git clone https://github.com/brendanjohnharris/SpatiotemporalMotifs.jl`)
cd("SpatiotemporalMotifs.jl")
using Pkg
Pkg.activate(".")
Pkg.instantiate()
```
The steps above will reproduce the exact versions of all dependencies used to generate the final results of the paper; running `Pkg.update()` afterwards (not recommended) will update all dependencies to their newest allowed versions.

> [!WARNING]
>The Python dependencies should install automatically, but if you encounter issues, please see the documentation for [CondaPkg.jl](https://github.com/JuliaPy/CondaPkg.jl). As a last resort, you can always create a conda environment yourself, manually install the Python dependencies (listed in the `CondaPkg.toml` files of [AllenSDK.jl](https://github.com/brendanjohnharris/AllenSDK.jl) and [FOOOF.jl](https://github.com/beacon-biosignals/PyFOOOF.jl)), set `JULIA_CONDAPKG_ENV` to point to this environment, and disable automatic Conda updates with `JULIA_CONDAPKG_OFFLINE=false`.

You should then set the `AllenNeuropixels` data directory to some place convenient, with:
```julia
import AllenNeuropixels as AN
AN.setdatadir("/path/to/my/data/")
```
All Neuropixels data files will be downloaded to this directory; by default it is a Julia scratchspace.
Note that all other working and intermediate data files for this project will be saved to `SpatiotemporalMotifs.jl/data`.

#### Key dependencies

This project depends significantly on some key dependencies, highlighted below. These packages---beyond the full list of dependencies contained in `Project.toml`

##### Dr Watson

...............................

##### AllenNeuropixels

...............

##### TimeseriesTools

..................

##### Foresight

..................


### 1. Performing calculations

The project is divided into `plots`, `data`, `src`, and `scripts` subdirectories.
The `plots` directory contains all figures used in the accompanying journal article, as generated by the scripts in this project.
The `data` directory is initially empty, and will contains the calculated results, including any intermediate data.
The `src` directory contains the main modularized code for the project, whereas the `scripts` directory contains code for running the analyses defined in `src` and plotting the results; inside `scripts` are the `scripts/calculations` and `scripts/plots` directories.
Broadly, the `scripts` in `scripts/calculations` will produce data required for the scripts in `scripts/plots`, and _all_ scripts in `scripts/calculations` should be run before any scripts in `scripts/plots`.
In this section we walk through the order in which `scripts/calculations/*` should be run, treating `scripts/plots` in [Section 2](#2.-plotting-results).
Each script can be run as `julia -t auto <path to script>` or, on Linux, `chmod u+x <path to script>` followed by executing `<path to script>`.
Please hover over the header links to see the file name for each script.

#### [Selecting sessions](scripts/calculations/session_selection.jl)

First, we use the session metadata to filter sessions that fulfill a list of quality criteria (e.g. probes in all target regions, with low noise).
This script creates the `data/session_table.jld2` file, which contains a `Dataframe` of the selected sessions and their metrics (also saved in JSON format at `data/session_table.json`).

#### [Downloading data](scripts/calculations/download_data.jl)

While the [AllenNeuropixels.jl](www.github.com/brendanjohnharris/AllenNeuropixels.jl) package can download data files on-demand, we recommend downloading the data files in advance to verify the data are complete and to avoid internet connection issues on computing nodes. Downloading the data can take many hours, and requires a strong internet connection. Please note this script will download the data files to a Julia scratchspace unless a custom directory is set (see [AllenNeuropixels.jl](www.github.com/brendanjohnharris/AllenNeuropixels.jl) for instructions).
This script creates the `data/power_spectra` directory, containing `.jld2` files with power spectra for each session, structure, and stimulus, as well as the `data/power_spectra_plots` directory, containing plots of the same spectra.

#### [Power spectra](scripts/calculations/cluster/power_spectra.jl)

Located at `scripts/calculations/cluster/power_spectra.jl`, this script calculates the power spectra of the local field potentials for each session, seven structure (the six visual cortical regions and the dorsal lateral geniculate nucleus), and three stimuli (spontaneous, flashes, and task-active natural images).
This script must be run on a high-performance computing cluster, and will need to be tweaked to use a cluster manager other than the University of Sydney School of Physics HPC (managed by the [USydClusters.jl](https://github.com/brendanjohnharris/UsydClusters.jl) package). To ensure your cluster manager is functioning correctly, please edit the `scripts/calculations/cluster/testscript.jl` file until it returns without error. You may need to run this script again in the REPl to ensure there are no errors (this script is prone to memory overflow).

#### [Calculations](scripts/calculations/cluster/calculations.jl)

This script performs the bulk of the wave-based calcualtions, and must be run on a high-performance computing cluster. If you have configured a custom [ClusterManager](https://github.com/JuliaParallel/ClusterManagers.jl), you can set the `ENV["JULIA_DISTRIBUTED"]=true` to have this file distribute calculations across multiple processes. Otherwise, the script will take about 2 days to run on a single high-memory (>64GB) machine.

#### [Post-hoc session filtering](scripts/calculations/posthoc_session_filter.jl)

There are some session quality metrics---the layer assignment consistency, and subject performance---that we can only calculate after collecting and formatting the data. This script filters out sessions that do not meet our post-hoc quality criteria, and saves the results in `data/posthoc_session_table.jld2` and `data/posthoc_session_table.json`.

#### [Storing unified layer annotations](scripts/calculations/grand_unified_layers.jl)

At times it will be useful to have precomputed unified layer annotations for all sessions and structures; this script produces these annotations and saves them in `data/grand_unified_layers.jld2`.

### 2. Plotting results

#### Schematics

.......

To produce the supplemental 'glass brain' movie, you will need to manually install and configure RPR makie on a machine with a sizeable GPU. The script `scripts/plots/glass_brain.jl` will produce jpeg images for each frame of the animation, which you can stitch together with e.g. the `magick` command-line tool.

#### [Power spectra](scripts/plots/power_spectra.jl)

This script produces Fig. 2 of the paper, summarizing the spectral properties of visual cortical LFP.
It also produces version of Fig. 2 for other visual stimuli.
The script will take about 2 hours to run without pre-computed `fooof.jld` files, otherwise, about 15 minutes.

#### Theta propagation

1. [Theta wavenumbers](scripts/plots/theta_wavenumbers.jl): produces panels A--C of Fig.3, heatmaps of the median wavenumber in `VISl` during hit, miss, and flash trials.
2. [Order parameter](scripts/plots/theta_order_parameter.jl):.............
3. [Inter-areal phase delays](scripts/plots/interareal_phasedelays.jl):.............

#### Gamma bursts and nested oscillations

1. [Gamma bursts](scripts/plots/gamma_bursts_task.jl)
2. [Nested oscillations](scripts/plots/pac_task.jl)
3. [Gamma bursts and nested oscillations](scripts/plots/classical_pac_task.jl.jl)

#### Spike-time coordination
1. [Spike..](scripts/plots/spike_ppc.jl)

