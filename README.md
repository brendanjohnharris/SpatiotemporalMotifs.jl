# SpatiotemporalMotifs.jl
[![Zenodo](https://img.shields.io/badge/Zenodo-1682D4?logo=zenodo&logoColor=fff&style=for-the-badge)](https://doi.org/10.5281/zenodo.14550386)
[![Figshare](https://img.shields.io/badge/figshare-556472?logo=figshare&logoColor=fff&style=for-the-badge)](https://doi.org/10.6084/m9.figshare.29928659)

Julia code for reproducing the results of _Nested spatiotemporal theta-gamma waves organize hierarchical visual processing_.

## Guide

Installation should be straightforward:
```julia
run(`git clone https://github.com/brendanjohnharris/SpatiotemporalMotifs.jl`)
cd("SpatiotemporalMotifs.jl")
using Pkg
Pkg.activate(".")
Pkg.instantiate()
```
The steps above will reproduce the exact versions of all dependencies used to generate the final results of the paper.
Running `Pkg.update()` afterwards (**not recommended**) will update all dependencies to their newest allowed versions.

> [!WARNING]
>The Python dependencies should install automatically, but if you encounter issues, please see the documentation for [CondaPkg.jl](https://github.com/JuliaPy/CondaPkg.jl). As a last resort, you can always create a conda environment yourself, manually install the Python dependencies (listed in the `CondaPkg.toml` files of [AllenSDK.jl](https://github.com/brendanjohnharris/AllenSDK.jl) and [FOOOF.jl](https://github.com/beacon-biosignals/PyFOOOF.jl)), set `JULIA_CONDAPKG_ENV` to point to this environment, and disable automatic Conda updates with `JULIA_CONDAPKG_OFFLINE=true`.

You should then set the `AllenNeuropixels` data directory to some place convenient, with:
```julia
import AllenNeuropixels as AN
AN.setdatadir("/path/to/my/data/")
```
All Neuropixels data files will be downloaded to this directory; by default it is a Julia scratchspace.

#### Reproduce calculations or just figures?

You can choose between:
1. Reproducing the full set of calculations and analyses, by running the code on a high-performance computing cluster. You will need to adapt the scripts to use the cluster manager of your favorite supercomputer. This option is described in [step 1](#1.-performing-calculations) below.
2. Downloading the full precomputed dataset from [[figshare]] and running final analyses yourself; go to [step 2](#2.-final-analyses). This option requires a desktop with a modest amount of RAM (>32 GB), and will still take around a day to complete.
3. Re-plotting figures using a precomputed, reduced dataset; go to [step 3](#3.-replotting-all-results). This option can be done on a local laptop machine, or online via the CodeOcean capsule.


#### Key dependencies

This project depends crucially on the dependencies highlighted below. A full list of dependencies can be found in `Project.toml`, with exact versions in the `Manifest.toml`.

##### [AllenNeuropixels.jl](https://github.com/brendanjohnharris/AllenNeuropixels.jl)

For accessing and processing the 'Allen Neuropixels---Visual Behavior' dataset.
See also [AllenNeuropixelsBase.jl](https://github.com/brendanjohnharris/AllenNeuropixelsBase.jl) and [AllenSDK.jl](https://github.com/brendanjohnharris/AllenSDK.jl) for component functionalities.

##### [TimeseriesTools](https://github.com/brendanjohnharris/TimeseriesTools.jl)

For power spectra and wave-based analyses, as well as general time-series manipulation.

##### [Makie](https://github.com/MakieOrg/Makie.jl) and [Foresight](https://github.com/brendanjohnharris/Foresight.jl)

For figures and visualization. `Makie` is a powerful graphics package, and the 'physics' theme from `Foresight` was used for all figures.

##### [Dr Watson](https://github.com/JuliaDynamics/DrWatson.jl)

For project standardization and reproducibility.




### 1. Performing calculations

The project is divided into `plots`, `data`, `src`, and `scripts` subdirectories.
The `plots` directory contains all figures used in the accompanying journal article, as generated by the scripts in this project.
The `data` directory is initially empty, and will contain the calculated results, including any intermediate data.
The `src` directory contains the main modularized code for the project, whereas the `scripts` directory contains code for running the analyses defined in `src` and plotting the results; inside `scripts` are the `scripts/calculations` and `scripts/plots` directories.
Broadly, the `scripts` in `scripts/calculations` will produce data required for the scripts in `scripts/plots`, and _all_ scripts in `scripts/calculations` should be run before any scripts in `scripts/plots`.
In this section we walk through the order in which `scripts/calculations/*` should be run, dealing with `scripts/plots` in [Section 2](#2.-plotting-results).
Each script can be run as `julia +1.10.10 -t auto <path to script>` or, on Linux, `chmod u+x <path to script>` followed by executing `<path to script>`; ensure you have added the v1.10.10 (current LTS) channel to your [`juliaup`](https://github.com/JuliaLang/juliaup) installation.
Please hover over the header links to see the file name for each script.

#### [Selecting sessions](scripts/calculations/session_selection.jl)

First, we use the session metadata to filter sessions that fulfill a list of quality criteria (e.g. probes in all target regions, with low noise).
This script creates the `data/session_table.jld2` file, which contains a `Dataframe` of the selected sessions and their metrics (also saved in JSON format).

#### [Downloading data](scripts/calculations/download_data.jl)

While the [AllenNeuropixels.jl](https://github.com/brendanjohnharris/AllenNeuropixels.jl) package can download data files on-demand, we recommend downloading the data files in advance to verify the data are complete and to avoid internet connection issues on computing nodes. Downloading the data can take many hours, and requires a strong internet connection. Please note this script will download the data files to a Julia scratchspace unless a custom directory is set (see [AllenNeuropixels.jl](https://github.com/brendanjohnharris/AllenNeuropixels.jl) for instructions).
This script creates the `data/power_spectra` directory, containing `.jld2` files with power spectra for each session, structure, and stimulus, as well as the `data/plots/power_spectra_plots` directory, containing plots of the same spectra.

#### [Power spectra](scripts/calculations/cluster/power_spectra.jl)

Located at `scripts/calculations/cluster/power_spectra.jl`, this script calculates the power spectra of the local field potentials for each session, seven structures (the six visual cortical regions and the dorsal lateral geniculate nucleus), and three stimuli (spontaneous, flashes, and task-active natural images).
This script must be run on a high-performance computing cluster, and will need to be tweaked to use a cluster manager other than the University of Sydney School of Physics HPC (managed by the [USydClusters.jl](https://github.com/brendanjohnharris/UsydClusters.jl) package). To ensure your cluster manager is functioning correctly, please edit the `scripts/calculations/cluster/testscript.jl` file until it returns without error. You may need to run this script again in the REPL to ensure there are no errors (this script is prone to memory overflow).

#### [Calculations](scripts/calculations/cluster/calculations.jl)

This script performs the bulk of the wave-based calculations, and must be run on a high-performance computing cluster; this will take about 2 days to run on a single high-memory (>64GB) machine.

#### [Collecting calculations](scripts/calculations/collect_calculations.jl)

This script collects the calculations generated by the previous script, which were distributed over many files, into a single data file for each stimulus type. The accompanying data repository contains the consolidated datafiles produced by this script.

#### [Post-hoc session filtering](scripts/calculations/posthoc_session_filter.jl)

There are some session quality metrics---the layer assignment consistency, and subject performance---that we can only calculate after collecting and formatting the data. This script filters out sessions that do not meet our post-hoc quality criteria, and saves the results in `data/plots/posthoc_session_table.jld2` and `data/plots/posthoc_session_table.json`. Lastly, this script produces the `experimental model details` table included in the star methods (`data/plots/experimental_model_table.csv`).

#### [Unifying calculations](scripts/calculations/unify_calculations.jl)

This script aligns the collected session-specific calculations for each structure to the average distribution of layers, and saves a precomputed set of unified layer annotations to `data/plots/grand_unified_layers.jld2`.

### 2. Final analyses
The following scripts take the calculated data from [step 1](#1.-performing-calculations), perform statistical analyses, save to a reduced plot dataset (`data/plots/`), then generate generate figures (saved to `plots/`).
The resulting plot data and figure files can be found on Figshare.

#### Fig. 1: Schematics

1. [`fig1.jl`](scripts/plots/fig1.jl): generates the wave illustration in Fig. 1a, and versions of the methods schematic in Fig. 1 for each visual cortical region.
2. [`videoS1.jl`](scripts/plots/videoS1.jl): produces jpeg images for each frame of the 'glass brain' Supplementary Movie, which you can stitch together with e.g. the [`magick`](https://github.com/ImageMagick/ImageMagick) command-line tool. You will need to manually install and configure [RPRMakie](https://docs.makie.org/stable/explanations/backends/rprmakie) on a machine with a sizeable GPU to run this script.

#### Fig. 2: Power spectra

[`fig2.jl`](scripts/plots/fig2.jl) produces a figure summarizing the spectral properties of visual cortical LFPs.
It also produces a version of Fig. 2 for other visual stimuli (Fig. S5 and Fig. S6).
The script will take about 2 hours to run without pre-computed `fooof.jld` files, otherwise, about 15 minutes.

#### Fig. 3: Translaminar theta propagation

1. [`fig3.jl`](scripts/plots/fig3.jl): produces heatmaps of the median wavenumber in `VISl` during hit, miss, and flash trials, as well as order parameter time courses and LDA hit/miss classification. This script also produces the supplemental wavenumber (Fig. S7) and current-source density (Fig. S8) figures.

#### Fig. 4: Hierarchical theta propagation
[`fig4.jl`](scripts/plots/fig4.jl) plots anatomical and functional networks as well as hierarchical order parameters.

#### Fig. 5: Gamma packets and nested dynamics
[`fig5.jl`](scripts/plots/fig5.jl) plots gamma burst width and theta--gamma phase-amplitude coupling, as well as supplemental comodulagrams (Fig. S9) and spatiotemporal theta--gamma coupling heatmaps (Fig. S10).

#### Fig. 6: Spike-LFP coupling
[`fig6.jl`](scripts/plots/fig6.jl) plots spike--phase coupling for theta, spike--amplitude coupling for gamma, and preferred spike--theta phase during the task period, as well as preffered phase and firing rate differences between hit and miss trials. This script also produces a spike-LFP coupling figure for the spontaneous condition (Fig. S11), and firing-rate time courses for all visual areas (Fig. S12).

### 3. Replotting all results

If you have downloaded the plot data from [Figshare](https://doi.org/10.6084/m9.figshare.29928659), and placed the `data` directory in the project root folder, you can replot all figures by running the [`produce_figures.jl`](produce_figures) shell script.
This file simply runs all of the plot scripts in the order listed in [step 2](#2.-final-analyses) and saves the results to `plots/`, taking around an hour. Ensure that you have properly instantiated this project via the Julia REPL before running this script.


## Project configuration
You can configure this project by setting the following environment variables, either in your shell startup script (`SM_THETA` and `SM_GAMMA`) or with the `Preferences` package.
By setting the following values and running [`fig3.jl`](scripts/plots/fig3.jl) and [`fig4.jl`](scripts/plots/fig4.jl), you can produce theta propagation figures for 3--5 Hz and 6--10 Hz bands (Fig. S13. and Fig. S14).
```julia
using Preferences, SpatiotemporalMotifs
set_preferences!(SpatiotemporalMotifs, "theta" => "(3, 10)", force=true) # Theta band, in Hz
set_preferences!(SpatiotemporalMotifs, "gamma" => "(30, 100)", force=true) # Gamma band, in Hz
```
