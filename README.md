# SpatiotemporalMotifs.jl

Julia code for reproducing the study "_Cross-scale spatiotemporal dynamics organize hierarchical processing in the mouse visual cortex_".

## Guide

Installation should be straightforward:
```julia
run(`git clone https://github.com/brendanjohnharris/SpatiotemporalMotifs.jl`)
cd("SpatiotemporalMotifs.jl")
using Pkg
Pkg.activate(".")
Pkg.instantiate()
```
The steps above will reproduce the exact versions of all dependencies used to generate the final results of the paper.
Running `Pkg.update()` afterwards (**not recommended**) will update all dependencies to their newest allowed versions.

> [!WARNING]
>The Python dependencies should install automatically, but if you encounter issues, please see the documentation for [CondaPkg.jl](https://github.com/JuliaPy/CondaPkg.jl). As a last resort, you can always create a conda environment yourself, manually install the Python dependencies (listed in the `CondaPkg.toml` files of [AllenSDK.jl](https://github.com/brendanjohnharris/AllenSDK.jl) and [FOOOF.jl](https://github.com/beacon-biosignals/PyFOOOF.jl)), set `JULIA_CONDAPKG_ENV` to point to this environment, and disable automatic Conda updates with `JULIA_CONDAPKG_OFFLINE=true`.

You should then set the `AllenNeuropixels` data directory to some place convenient, with:
```julia
import AllenNeuropixels as AN
AN.setdatadir("/path/to/my/data/")
```
All Neuropixels data files will be downloaded to this directory; by default it is a Julia scratchspace.

#### Reproduce calculations or just figures?

You can choose between:
1. Reproducing the full set of calculations and analyses, by running the code on a high-performance computing cluster. You will need to adapt the scripts to use the cluster manager of your favorite supercomputer. This option is described in [step 1](#1.-performing-calculations) below.
2. Downloading the full precomputed dataset from [[figshare]] and running final analyses yourself; go to [step 2](#2.-final-analyses). This option requires a desktop with a modest amount of RAM (>16 GB), and some scripts will still take around 30 minutes to complete.
Note that all other working and intermediate data files for this project will be saved to `SpatiotemporalMotifs.jl/data`.
3. Re-plotting figures using a precomputed, reduced dataset; go to [step 3](#3.-replotting-all-results). This option can be done on a local laptop machine, or online via this CodeOcean capsule.


#### Key dependencies

This project depends crucially on the dependencies highlighted below. A full list of dependencies can be found in `Project.toml`, with exact versions in the `Manifest.toml`.

##### [AllenNeuropixels.jl](https://github.com/brendanjohnharris/AllenNeuropixels.jl)

For accessing and processing the 'Allen Neuropixels---Visual Behavior' dataset.
See also [AllenNeuropixelsBase.jl](https://github.com/brendanjohnharris/AllenNeuropixelsBase.jl) and [AllenSDK.jl](https://github.com/brendanjohnharris/AllenSDK.jl) for component functionalities.

##### [TimeseriesTools](https://github.com/brendanjohnharris/TimeseriesTools.jl)

For power spectra and wave-based analyses, as well as general time-series manipulation.

##### [Makie](https://github.com/MakieOrg/Makie.jl) and [Foresight](https://github.com/brendanjohnharris/Foresight.jl)

For figures and visualization. `Makie` is a powerful graphics package, and the 'physics' theme from `Foresight` was used for all figures.

##### [Dr Watson](https://github.com/JuliaDynamics/DrWatson.jl)

For project standardization and reproducibility.




### 1. Performing calculations

The project is divided into `plots`, `data`, `src`, and `scripts` subdirectories.
The `plots` directory contains all figures used in the accompanying journal article, as generated by the scripts in this project.
The `data` directory is initially empty, and will contain the calculated results, including any intermediate data.
The `src` directory contains the main modularized code for the project, whereas the `scripts` directory contains code for running the analyses defined in `src` and plotting the results; inside `scripts` are the `scripts/calculations` and `scripts/plots` directories.
Broadly, the `scripts` in `scripts/calculations` will produce data required for the scripts in `scripts/plots`, and _all_ scripts in `scripts/calculations` should be run before any scripts in `scripts/plots`.
In this section we walk through the order in which `scripts/calculations/*` should be run, dealing with `scripts/plots` in [Section 2](#2.-plotting-results).
Each script can be run as `julia -t auto <path to script>` or, on Linux, `chmod u+x <path to script>` followed by executing `<path to script>`.
Please hover over the header links to see the file name for each script.

#### [Selecting sessions](scripts/calculations/session_selection.jl)

First, we use the session metadata to filter sessions that fulfill a list of quality criteria (e.g. probes in all target regions, with low noise).
This script creates the `data/session_table.jld2` file, which contains a `Dataframe` of the selected sessions and their metrics (also saved in JSON format at `data/session_table.json`).

#### [Downloading data](scripts/calculations/download_data.jl)

While the [AllenNeuropixels.jl](https://github.com/brendanjohnharris/AllenNeuropixels.jl) package can download data files on-demand, we recommend downloading the data files in advance to verify the data are complete and to avoid internet connection issues on computing nodes. Downloading the data can take many hours, and requires a strong internet connection. Please note this script will download the data files to a Julia scratchspace unless a custom directory is set (see [AllenNeuropixels.jl](https://github.com/brendanjohnharris/AllenNeuropixels.jl) for instructions).
This script creates the `data/power_spectra` directory, containing `.jld2` files with power spectra for each session, structure, and stimulus, as well as the `data/plots/power_spectra_plots` directory, containing plots of the same spectra.

#### [Power spectra](scripts/calculations/cluster/power_spectra.jl)

Located at `scripts/calculations/cluster/power_spectra.jl`, this script calculates the power spectra of the local field potentials for each session, seven structures (the six visual cortical regions and the dorsal lateral geniculate nucleus), and three stimuli (spontaneous, flashes, and task-active natural images).
This script must be run on a high-performance computing cluster, and will need to be tweaked to use a cluster manager other than the University of Sydney School of Physics HPC (managed by the [USydClusters.jl](https://github.com/brendanjohnharris/UsydClusters.jl) package). To ensure your cluster manager is functioning correctly, please edit the `scripts/calculations/cluster/testscript.jl` file until it returns without error. You may need to run this script again in the REPL to ensure there are no errors (this script is prone to memory overflow).

#### [Calculations](scripts/calculations/cluster/calculations.jl)

This script performs the bulk of the wave-based calculations, and must be run on a high-performance computing cluster. If you have configured a custom [ClusterManager](https://github.com/JuliaParallel/ClusterManagers.jl), you can set the `ENV["JULIA_DISTRIBUTED"]=true` to have this file distribute calculations across multiple processes. Otherwise, the script will take about 2 days to run on a single high-memory (>64GB) machine.

#### [Post-hoc session filtering](scripts/calculations/posthoc_session_filter.jl)

There are some session quality metrics---the layer assignment consistency, and subject performance---that we can only calculate after collecting and formatting the data. This script filters out sessions that do not meet our post-hoc quality criteria, and saves the results in `data/posthoc_session_table.jld2` and `data/posthoc_session_table.json`. Lastly, this script produces the `experimental model details` table included in the star methods (`data/experimental_model_table.csv`).

#### [Storing unified layer annotations](scripts/calculations/grand_unified_layers.jl)

At times it will be useful to have precomputed unified layer annotations for all sessions and structures; this script produces these annotations and saves them in `data/plots/grand_unified_layers.jld2`.

### 2. Final analyses
The following scripts take the calculated data from [step 1](#1.-performing-calculations), perform statistical analyses, save to a reduced plot dataset (`data/plots/`), then generate generate figures (saved to `plots/`).
The resulting plot data and figure files have can be found on Figshare.

#### Fig. 1: Schematics

1. [`fig1.jl`](scripts/plots/fig1.jl): generates the wave illustration in Fig. 1a, and versions of the methods schematic in Fig. 1 for each visual cortical region.
2. [`glass_brain.jl`](scripts/plots/glass_brain.jl): produces jpeg images for each frame of the 'glass brain' Supplementary Movie, which you can stitch together with e.g. the [`magick`](https://github.com/ImageMagick/ImageMagick) command-line tool. You will need to manually install and configure [RPRMakie](https://docs.makie.org/stable/explanations/backends/rprmakie) on a machine with a sizeable GPU to run this script.

#### Fig. 2: Power spectra

[`fig2.jl`](scripts/plots/fig2.jl) produces a figure summarizing the spectral properties of visual cortical LFPs.
It also produces a version of Fig. 2 for other visual stimuli.
The script will take about 2 hours to run without pre-computed `fooof.jld` files, otherwise, about 15 minutes.

#### Fig. 3: Translaminar theta propagation

1. [`theta_wavenumbers.jl`](scripts/plots/theta_wavenumbers.jl): produces panels A--C of Fig.3, heatmaps of the median wavenumber in `VISl` during hit, miss, and flash trials.
2. [`theta_order_parameter.jl`](scripts/plots/theta_order_parameter.jl): panels D--F of Fig. 3, order parameter time courses and LDA hit/miss classification.

#### Fig. 4: Hierarchical theta propagation
[`interareal_phasedelays.jl`](scripts/plots/interareal_phasedelays.jl) plots anatomical and functional networks as well as hierarchical order parameters.

#### Fig. 5: Gamma packets and nested dynamics
[`nested_dynamics.jl`](scripts/plots/nested_dynamics.jl) plots gamma burst width and theta--gamma phase-amplitude coupling

#### Fig. 6: Spike-LFP coupling
[`spike_lfp.jl`](scripts/plots/spike_lfp.jl) plots spike--phase coupling for theta, spike--amplitude coupling for gamma, and preferred spike--theta phase during both spontaneous and task periods.

### 3. Replotting all results

If you have downloaded the plot data from Figsahre, and placed the data files in `data/plots/`, you can replot all figures by running the [`produce_figures.jl`](produce_figures) shell script.
This file simply runs all of the plot scripts in the order listed in [step 2](#2.-final-analyses) and saves the results to `plots/`. Ensure that you have properly instantiated this project via the Julia REPL before running this script.
